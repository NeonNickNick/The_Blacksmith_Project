假设我们已经理解了老打铁。接下来的玩法基于老打铁。
# Section1 回合制
老打铁是一个同步回合制游戏。

现在将其变为一个二重回合制游戏。外部回合称为母回合，内部回合称为子回合。一组子回合完成后，母回合+1。

例如，将回合记为：母回合.子回合。一个进行方式是1.1->1.2->1.3->2.1->2.2.....

与老打铁进行对应时，老打铁的回合对应于这里的子回合。

二重回合制主要为了模块（2.1）服务。

# Section2 技能
老打铁战斗基于职业技能。

现在将其拆分成两部分。第一部分是决定要出什么技能，技能的强度是怎样的，第二部分是出技能。

## 2.1 模块系统
模块服务于第一部分，即决定要出什么技能，技能的强度是怎样的。

在老打铁中，技能的数值一般是不能变的。打铁一定是打1个铁，切一定是5伤，时之盾一定是2RDEF。即使可以变，例如战矛技能，我们总是可以将其归结为buff。

因此，老打铁是一个含buff系统的资源->技能型游戏，buff必定来自于技能。一个buff往前追溯一定能找到产生它的技能。归根结底，技能强度是一开始就指定不能变的，这取决于策划给的数值。

模块系统是一个新的额外前导系统。它是完全独立于老打铁的一部分。它的作用是改变技能强度和引导组合技能。
### 2.1.1 直观理解模块
一个直观理解是模块是一个多边形，每个角上都有一个输入和输出。如何理解输入输出？这就好比电路图，如果这个角能够引出一根导线，它就是输出。如果能接收一根导线，它就是输入。

任何一个角必须是输入和输出中的一种。输入只能接收一根导线，输出只能引出一根导线。

导线传递的是一个包。暂时不需要关心这个包里是什么。

模块内部有一套计算逻辑。它会根据输入的包计算出输出的包。

### 2.1.2 模块之间的组合
如果把输出导线连到输入，这两个模块就组合起来了。当然也可以自己连到自己。

假设模块A输出连接到模块B输入。当模块A的输出被计算后，模块A的输出处就有一个包了。如果模块B向模块A发起请求，想要得到自己的输入，模块A就会把自己的输出包做一个深拷贝，并通过导线将其传递到模块B的输入。B一旦接收到包，就会用这个包替换原来的输入包（如果没有的话，原来的包就是一个空包（2.3.2））

模块B收到这个包后，它就会开始计算自己的输出包。
### 2.1.3 模块之间的包传递规则
现在可以揭示模块系统的全部细节。

假设现在有很多个模块被相互连起来了。由于有输入和输出的概念，这个模块图是一个有向图。

我们先假设这个图是无环的。

我们预先指定一个模块S，它有两个输入和一个输出。模块的计算从这里启动。模块的连接方式为（假设模块A,B都是单输入单输出模块）：

    空->A
        A->S
            S->外部
        B->S
    C->B

现在，模块S启动。启动时，它检查自己的两个输入，发现没有找到包。于是先要得到包。

因此，它首先向模块A发送请求。模块A接收到请求之后就启动。经过检查，它的输入没有任何包，也找不到其他模块的引线，于是A就开始计算了。

注意！不是没有包就不能计算。经过检查和请求流程之后，无论有没有包或上一级模块，都会开始计算。

计算过程涉及解包。这个暂时不讨论。

A经过计算，得到了输出包。由于刚才S进行了请求，它就把这个包的拷贝发给S。

S收到这个包之后，就开始向B发起请求。模块B接收到请求之后就启动。经过检查，它的输入没有任何包，但是有模块C的引线，于是先要得到包。它首先向模块C发送请求。模块C接收到请求之后就启动。以此类推。

这个过程是一个深度优先搜索。搜索完成后，从启动节点S得到最终的输出包。

刚才只讨论了无环图的情况。我们额外限定一个模块每次深度优先搜索中至多只能接受一次请求，于是有环图也就等效于一个无环图。

## 2.2 复合标签系统
复合标签系统是模块系统的一部分，但是它又与技能系统紧密相关。

现在先来讨论包中有什么东西。

源自老打铁有一种抽象。一个技能总可以找到一个唯一的二级分类，例如：法杖->魔盾、钢炮->炮击。

现在先定义包中有什么东西。

    1.一个数字，它的精度是0.1；
    2.内标签，它是一对（分类，二级分类）标签，例如（法杖，魔盾）；
    3.一个外标签列表，它是一个（分类，二级分类）标签列表，例如【（法杖，魔盾），（钢炮，炮击）】

现在明确指出，这个内标签和外标签列表等价于老打铁中的二级分类，这种内外标签结合的系统称为复合标签系统。我们暂时不讨论这个数字是什么。

我们把一个模块称为刺模块，如果这个模块输出的包中的内标签全部都是：通用->刺。在这一部分的内容中，我们说刺时就是在说刺模块。

我们现在还不知道复合标签是怎么来的，有什么作用。

### 2.2.1 复合标签的来源：解包
考虑一个简单的例子。我们将一个刺的输出连接到打铁的输入，打铁的输入连接到盾的输入。为了简单起见，假设各只有一个输入和一个输出。以下所有的数值都是随便指定的。

刺的标签是：通用->刺。

打铁的标签是：通用->打铁。

盾的标签是：通用->盾。

从刺开始，它完成计算，输出的是包含内标签、空的外标签列表和数据1.0的包。

打铁接收到了这个包的副本。它首先看到有数值1.0，这个数值进入它的计算逻辑。

然后他开始处理包中的内标签和外标签列表。包中内标签和数值1.0此时结合成二元组（包中内标签，1.0）并被加入打铁的外标签列表。

接下来将包中的外标签列表合并到外标签列表。

最后完成计算逻辑。

到这里，打铁这个模块的输出包包含：一个数据（假设是2.0），一个内标签：通用->打铁，一个外标签列表[(通用->刺, 1.0)]

以此类推，盾的输出包包含：一个数据（假设是3.0），一个内标签：通用->盾， 一个外标签列表[(通用->刺, 1.0), (通用->打铁, 2.0)]

### 2.2.2 衰减
为了控制数值，在外标签中引入衰减机制。比如，如果某一个标签进入了新的外标签列表，那他的数值就要衰减50%。

这样，根据刚才的例子，我们可以重新得到：

到这里，打铁这个模块的输出包包含：一个数据（假设是2.0），一个内标签：资源->铁，一个外标签列表[(攻击->物理攻击, 0.5)]

以此类推，盾的输出包包含：一个数据（假设是3.0），一个内标签：防御->甲， 一个外标签列表[(攻击->物理攻击, 0.25), (资源->铁, 1.0)]

### 2.2.3 复合标签的作用
复合标签引入的目的主要在于进一步增强技能的组合性，制造更多丰富的技能效果。

现在，假设一个输出包输入到玩家。玩家会看到一个数据，一个内标签和一个外标签列表。

这个时候，玩家就可以执行多个技能，因为这里有2*（1+n）个标签-数值对，同时衰减控制了组合的数值。



## 2.3 技能系统
技能系统非常像老打铁的技能系统。在具体讨论之前，先回顾一下之前的模块系统和复合标签系统做了什么。

模块系统要求玩家连接模块图，从一个模块开始请求。模块经过请求上一级模块的输出包，解包，数值进入计算逻辑，标签合并至外标签列表，然后向下一级输出包。经过深度优先搜索，最终得到起始请求模块的输出包。这个包中有一个数字，一个内标签和一个外标签列表。

首先，我们约定这个最终输出包会输入到玩家。玩家被看成是一个特殊的模块，而起始请求模块可以视为是玩家模块。

玩家看到这个包中的内容，会触发一个新的逻辑。
### 2.3.1 包中的数值
现在终于可以讨论包中的数值。

包中的数值是对应内标签技能的增幅系数（这意味着如果没有任何输入它应该输出1.0！）。例如。玩家看到了一个数值1.5，同时内标签对应的技能是切，那切就被增幅，伤害变为5*1.5，玩家将会出被增幅的切。

值得注意的是，还有外标签列表。它和内标签同样都被像上面说的那样解析，因此，玩家就可以连续出多个增幅技能。
### 2.3.2 空包
在资源不够的情况下（3.2），输出会是一个空包。空包记为null，它的里面没有任何东西。

注意这和数字为0.0的包有本质区别。
### 2.3.3 技能
这一部分可以视为判定简化版的老打铁。由于老打铁的改进方案还没有出来，暂时不讨论。

## 2.4 总览
综上所述，新的玩法主要有两套系统。

第一套是模块系统。它的作用是得到技能的增幅系数，并将增幅系数和技能标签对传递给玩家。这个过程相当于给玩家发指令。玩家接收到指令之后，就像老打铁一样使用技能，只不过允许技能增幅，同时一回合可以出多个技能。

如果我们采用归一化的初始增幅系数1.0，对于可加成技能调整初始增幅系数，也许就可以继续采用老打铁的数值。

    模块系统->修改版老打铁

## 2.5 多输出口
多输出口是一个值得讨论的问题。
### 2.5.1 是否有必要给模块组合准备多个出口？
我认为有必要。

根据直观想象多输出口的收益不高于单输出口。因为为了鼓励玩家组合，组合效果一般是大于二者之和的。这个时候应该倾向于组合技能。

其次，每个子回合玩家都可以重连模块。因此不存在我想同时保留两种的情况。

但是，如果涉及到敌人机制，就有可能分开输出优于组合。例如如果敌人是攻击次数怪，那就应该不组合来得到更多攻击次数。

因此，至少应该预留可扩展到多个出口的能力。

### 2.5.2 要准备几个出口
应该限制出口的数量。我认为应该是常态2个。

# Section3 战斗流程
前面我们了解了相比老打铁新加入的模块系统和复合标签系统，并且知道了它是怎么和老打铁结合起来的。但是，还有很多细节没有说清楚，例如，模块的生命周期是什么，原来打铁中消耗资源的过程到哪里去了。接下来分阶段结合例子解释游戏流程。

## 3.1 进入战斗房
进入战斗房之后可以看到具体的敌人。为了简单起见，我们这里假定敌人每回合都会出刺，同时玩家有100点生命值。除了这个生命值外我们采用经典的老打铁数值。
## 3.2 开始战斗
在这里，我们先要明确模块的两个概念，请求和计算。

请求指的是模块向上一级申请包拷贝的过程，而计算是请求全部结束后，读取数值得到输出的过程。

现在回合是1.1.玩家需要决策模块怎么连接。在此处说明，模块取出和连接不消耗资源，但是计算消耗资源。这个资源就是老打铁中的铁、空间、时间等资源。如果这个时候资源不足，这个模块就会输出空包。尽管它输出的是空包，但是遍历过程不会中断。换言之，即使某一个连接链中有一处出现资源不足，它的上级只要资源足够还是可以正常计算的。

计算消耗资源而不是请求消耗资源是一个彩蛋。因为这意味着即使资源不足也可以请求。

这样的话，玩家出技能就不需要消耗资源了。这个可以理解为模块就已经充能过了，玩家技能只是使用这个能量。
### 3.2.1 母回合中
现在玩家取出了一个打铁模块，并且直接连到了自己身上。这个子回合他就出了打铁，因此结算后，玩家有1个铁，同时生命值为99.

现在回合到了1.2，这个时候，打铁模块没有消失，但是它进入了锁定状态。这一类的模块，一旦完成一次请求，以后就不能再请求了。但是，它依然可以发送自己输出包的深拷贝。

例如这个回合玩家继续将这个打铁模块连在自己身上。这个子回合他继续出打铁，结算后玩家有2个铁，同时生命值为98.

现在回合到了1.3，玩家拿出了刺，将刺连到自己，将打铁连到刺。假设打铁将刺增幅到了1.5倍，同时假设衰减比例是50%，那么这回合结算后，玩家有2个铁，生命值为98，对敌人造成了0.5伤害。

仔细解释这个过程。打铁固定了输出为1.0，发送到刺的包被解开后，内标签被添加到刺的外标签列表，数值变成了0.5，同时刺的增幅系数变为1.5。因此刺的伤害变成1.5，同时玩家还会出一个增幅系数为0.5的打铁。刺在计算过程中消耗了0.5铁，资源充足，计算成功。玩家出技能之后又获得了0.5铁。
### 3.2.2 跨母回合
假设现在进入新的母回合2.1.这个时候所有模块都被清除。以此往复直到战斗结束。
